<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦è‡ªåŠ¨åŒ– - æ™ºèƒ½å…»å·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-brand">ğŸš€ å°çº¢ä¹¦è‡ªåŠ¨åŒ–ç³»ç»Ÿ</div>
        <ul class="navbar-nav">
            <li class="nav-item"><a href="#" class="nav-link active" onclick="showPage('dashboard')">ä»ªè¡¨æ¿</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('device')">è®¾å¤‡ç®¡ç†</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('keyword')">å…³é”®è¯</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('param')">æ ¸å¿ƒå‚æ•°</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('visit')">è®¿é—®æ§åˆ¶</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('interact')">äº’åŠ¨é…ç½®</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('status')">å®æ—¶çŠ¶æ€</a></li>
        </ul>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <div class="main-content">
            
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="page active">
                <h1>ğŸ“Š ä»ªè¡¨æ¿</h1>
                
                <div class="alert alert-info">
                    <span>âš ï¸</span>
                    <span>è¯·å…ˆåœ¨ã€Œè®¾å¤‡ç®¡ç†ã€ä¸­é€‰æ‹©è®¾å¤‡ï¼Œå†è¿›è¡Œå…»å·é…ç½®ã€‚</span>
                </div>

                <h2>å½“å‰è®¾å¤‡</h2>
                <div id="current-device-display" class="status-card">
                    <div class="status-label">é€‰ä¸­è®¾å¤‡</div>
                    <div class="status-value" id="current-device-name">æœªé€‰æ‹©</div>
                </div>

                <h2>å¿«é€Ÿæ“ä½œ</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="startYangHao()">â–¶ï¸ å¯åŠ¨å…»å·</button>
                    <button class="btn btn-danger" onclick="stopYangHao()">â¹ï¸ åœæ­¢å…»å·</button>
                    <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                </div>

                <h2>å…»å·çŠ¶æ€</h2>
                <div class="status-card">
                    <div class="status-label">è¿è¡ŒçŠ¶æ€</div>
                    <div class="status-value" id="running-status">âšª æœªè¿è¡Œ</div>
                </div>
                <div class="status-card">
                    <div class="status-label">å·²è®¿é—®å¸–å­</div>
                    <div class="status-value" id="visited-count">0</div>
                </div>
                <div class="status-card">
                    <div class="status-label">å‰©ä½™æ—¶é—´</div>
                    <div class="status-value" id="remain-time">0 åˆ†é’Ÿ</div>
                </div>

                <h2>è¿›åº¦</h2>
                <div class="progress">
                    <div class="progress-bar" id="progress" style="width: 0%"></div>
                </div>

                <h2>æœ€è¿‘æ“ä½œæ—¥å¿—</h2>
                <div id="log-list" style="max-height: 300px; overflow-y: auto;">
                    <div class="alert alert-info">æš‚æ— æ—¥å¿—</div>
                </div>
            </div>

            <!-- è®¾å¤‡ç®¡ç† -->
            <div id="device" class="page">
                <h1>ğŸ“± è®¾å¤‡ç®¡ç†</h1>
                
                <h2>å·²è¿æ¥è®¾å¤‡</h2>
                <button class="btn btn-primary" onclick="refreshDevices()" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
                
                <div class="device-selector" id="device-list"></div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="switchDevice()">âœ“ ç¡®è®¤é€‰æ‹©</button>
                <button class="btn btn-primary" onclick="showPage('keyword')" style="margin-left: 10px;">ä¸‹ä¸€æ­¥:  è®¾ç½®å…³é”®è¯</button>
            </div>

            <!-- å…³é”®è¯ç®¡ç† -->
            <div id="keyword" class="page">
                <h1>ğŸ” æœç´¢å…³é”®è¯ç®¡ç†</h1>
                
                <h2>å½“å‰å…³é”®è¯åˆ—è¡¨</h2>
                <div id="keyword-list"></div>

                <h2>æ·»åŠ æ–°å…³é”®è¯</h2>
                <div class="form-group">
                    <input type="text" id="new-keyword" placeholder="è¾“å…¥å…³é”®è¯ï¼Œä¾‹ï¼šç§‘æŠ€èµ„è®¯">
                    <button class="btn btn-primary" onclick="addKeyword()" style="margin-top: 10px;">â• æ·»åŠ </button>
                </div>

                <h2>æ‰¹é‡å¯¼å…¥</h2>
                <div class="form-group">
                    <textarea id="keywords-import" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹ï¼š&#10;ç§‘æŠ€èµ„è®¯&#10;æ—…è¡Œæ”»ç•¥&#10;ç¾é£Ÿæ•™ç¨‹" rows="6"></textarea>
                    <button class="btn btn-primary" onclick="importKeywords()" style="margin-top: 10px;">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveKeywords()">ğŸ’¾ ä¿å­˜å…³é”®è¯</button>
            </div>

            <!-- æ ¸å¿ƒå‚æ•° -->
            <div id="param" class="page">
                <h1>âš™ï¸ æ ¸å¿ƒå‚æ•°é…ç½®</h1>

                <div class="form-group">
                    <label>å…»å·æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="duration-minutes" min="1" max="120" value="20">
                    <small style="color: #666;">èŒƒå›´ï¼š1-120åˆ†é’Ÿ</small>
                </div>

                <div class="form-group">
                    <label>è®¿é—®å¸–å­æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
                    <input type="range" id="post-visit-ratio" min="0" max="100" value="50">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="ratio-display" style="color: #667eea; font-weight: bold;">50%</span>
                        <small style="color: #666;">æœç´¢ç»“æœä¸­ä¼šè®¿é—®æ­¤æ¯”ä¾‹çš„å¸–å­</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ¯æ¬¡å…»å·æœ€å¤šç‚¹å‡»å¸–å­æ•°é‡</label>
                    <input type="number" id="max-posts" min="1" max="50" value="10">
                    <small style="color: #666;">èŒƒå›´ï¼š1-50æ¡</small>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveParams()">ğŸ’¾ ä¿å­˜å‚æ•°</button>
            </div>

            <!-- è®¿é—®æ§åˆ¶ -->
            <div id="visit" class="page">
                <h1>ğŸ‘ï¸ å¸–å­è®¿é—®æ§åˆ¶</h1>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter-image-text" checked>
                        ä»…è®¿é—®å›¾æ–‡ç±»å‹å¸–å­
                    </label>
                </div>

                <div class="form-group">
                    <label>è®¿é—®æ—¶é•¿èŒƒå›´ï¼ˆç§’ï¼‰</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="duration-min" min="5" max="60" value="25" style="flex: 1;">
                        <span>-</span>
                        <input type="number" id="duration-max" min="5" max="120" value="45" style="flex: 1;">
                    </div>
                    <small style="color: #666;">æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è®¿é—®æ—¶é•¿ï¼ˆéšæœºï¼‰</small>
                </div>

                <div class="form-group">
                    <label>å›¾ç‰‡æ»‘åŠ¨é—´éš”ï¼ˆç§’ï¼‰</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="slide-interval-min" min="1" max="10" value="3" style="flex: 1;">
                        <span>-</span>
                        <input type="number" id="slide-interval-max" min="1" max="10" value="5" style="flex: 1;">
                    </div>
                </div>

                <div class="form-group">
                    <label>æ»‘åŠ¨è·ç¦»</label>
                    <select id="slide-distance">
                        <option value="single_image">å•å¼ å›¾ç‰‡é«˜åº¦</option>
                        <option value="third_screen">å±å¹•1/3é«˜åº¦</option>
                        <option value="custom">è‡ªå®šä¹‰ï¼ˆåƒç´ ï¼‰</option>
                    </select>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveVisitControl()">ğŸ’¾ ä¿å­˜è®¿é—®æ§åˆ¶é…ç½®</button>
            </div>

            <!-- äº’åŠ¨é…ç½® -->
            <div id="interact" class="page">
                <h1>ğŸ’¬ äº’åŠ¨è¡Œä¸ºé…ç½®</h1>

                <h2>è¡Œä¸ºè§¦å‘æ¦‚ç‡</h2>

                <div class="form-group">
                    <label>ç‚¹èµæ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="like-prob" min="0" max="50" value="15">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="like-display" style="color: #667eea; font-weight: bold;">15%</span>
                        <small style="color: #666;">é»˜è®¤15%</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ”¶è—æ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="collect-prob" min="0" max="50" value="10">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="collect-display" style="color: #667eea; font-weight: bold;">10%</span>
                        <small style="color: #666;">é»˜è®¤10%</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¯„è®ºæ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="comment-prob" min="0" max="50" value="5">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="comment-display" style="color: #667eea; font-weight: bold;">5%</span>
                        <small style="color: #666;">é»˜è®¤5%</small>
                    </div>
                </div>

                <h2>è¯„è®ºæ¨¡æ¿åº“</h2>
                <div id="comment-templates-list"></div>

                <h2>æ·»åŠ è¯„è®ºæ¨¡æ¿</h2>
                <div class="form-group">
                    <input type="text" id="new-template" placeholder="è¾“å…¥æ–°çš„è¯„è®ºæ¨¡æ¿ï¼Œä¾‹ï¼šä¸é”™çš„åˆ†äº«ï¼">
                    <button class="btn btn-primary" onclick="addCommentTemplate()" style="margin-top: 10px;">â• æ·»åŠ </button>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveInteraction()">ğŸ’¾ ä¿å­˜äº’åŠ¨é…ç½®</button>
            </div>

            <!-- çŠ¶æ€ç›‘æ§ -->
            <div id="status" class="page">
                <h1>ğŸ“ˆ å®æ—¶çŠ¶æ€ç›‘æ§</h1>
                
                <h2>è®¾å¤‡çŠ¶æ€</h2>
                <div class="status-card">
                    <div class="status-label">è¿æ¥çŠ¶æ€</div>
                    <div class="status-value" id="connection-status">æœªè¿æ¥</div>
                </div>

                <h2>å…»å·è¿›åº¦</h2>
                <div class="status-card">
                    <div class="status-label">å½“å‰å…³é”®è¯</div>
                    <div class="status-value" id="current-keyword">æ— </div>
                </div>
                <div class="status-card">
                    <div class="status-label">å·²è®¿é—®å¸–å­</div>
                    <div class="status-value" id="status-visited-count">0</div>
                </div>
                <div class="status-card">
                    <div class="status-label">å‰©ä½™æ—¶é—´</div>
                    <div class="status-value" id="status-remain-time">0 åˆ†é’Ÿ</div>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        let currentDeviceId = null;
        let currentDeviceName = "æœªé€‰æ‹©";

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­é¡µé¢
            document.getElementById(pageId).classList.add('active');
            // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”é¡µé¢çš„æ•°æ®
            switch (pageId) {
                case 'device':
                    // åˆ‡æ¢åˆ°è®¾å¤‡ç®¡ç†é¡µé¢æ—¶ï¼Œæ— è®ºæ˜¯å¦é€‰æ‹©äº†è®¾å¤‡ï¼Œéƒ½åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                    refreshDevices();
                    break;
                case 'keyword':
                    if (currentDeviceId) refreshKeywords();
                    break;
                case 'interact':
                    if (currentDeviceId) loadCommentTemplates();
                    break;
                case 'param':
                    if (currentDeviceId) loadParams();
                    break;
                case 'visit':
                    if (currentDeviceId) loadVisitControl();
                    break;
            }
        }

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        function refreshDevices() {
            console.log('å¼€å§‹åˆ·æ–°è®¾å¤‡åˆ—è¡¨...');
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    console.log('è·å–è®¾å¤‡åˆ—è¡¨ç»“æœ:', data);
                    if (data.success) {
                        const deviceList = document.getElementById('device-list');
                        deviceList.innerHTML = '';
                        
                        if (data.data.length === 0) {
                            deviceList.innerHTML = '<div class="alert alert-info">æš‚æ— å·²è¿æ¥çš„è®¾å¤‡ï¼Œè¯·æ£€æŸ¥ADBè¿æ¥</div>';
                        } else {
                            data.data.forEach(device => {
                                const deviceOption = document.createElement('div');
                                deviceOption.className = 'device-option';
                                deviceOption.innerHTML = `
                                    <input type="radio" id="device-${device.id}" name="device" value="${device.id}">
                                    <label for="device-${device.id}">
                                        <strong>${device.name}</strong><br>
                                        <small>çŠ¶æ€: ${device.status}</small>
                                    </label>
                                `;
                                deviceList.appendChild(deviceOption);
                            });
                        }
                    } else {
                        alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('ç½‘ç»œé”™è¯¯:', error);
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // åˆ‡æ¢è®¾å¤‡
        function switchDevice() {
            const selectedDevice = document.querySelector('input[name="device"]:checked');
            if (!selectedDevice) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè®¾å¤‡');
                return;
            }
            const deviceId = selectedDevice.value;
            fetch('/api/device/switch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ device_id: deviceId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDeviceId = deviceId;
                    currentDeviceName = selectedDevice.nextElementSibling.querySelector('strong').textContent;
                    document.getElementById('current-device-name').textContent = currentDeviceName;
                    alert(data.message);
                    
                    // åŠ è½½è®¾å¤‡é…ç½®æ•°æ®
                    loadDeviceConfig();
                } else {
                    alert('åˆ‡æ¢è®¾å¤‡å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }
        
        // åŠ è½½è®¾å¤‡é…ç½®æ•°æ®
        function loadDeviceConfig() {
            if (!currentDeviceId) return;
            
            // åŠ è½½å…³é”®è¯
            refreshKeywords();
            
            // åŠ è½½è¯„è®ºæ¨¡æ¿
            loadCommentTemplates();
            
            // åŠ è½½æ ¸å¿ƒå‚æ•°
            loadParams();
            
            // åŠ è½½è®¿é—®æ§åˆ¶é…ç½®
            loadVisitControl();
        }
        
        // åŠ è½½æ ¸å¿ƒå‚æ•°
        function loadParams() {
            if (!currentDeviceId) return;
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const config = data.data;
                        // æ›´æ–°æ ¸å¿ƒå‚æ•°è¡¨å•
                        document.getElementById('duration-minutes').value = config.duration_minutes || 20;
                        document.getElementById('post-visit-ratio').value = config.post_visit_ratio || 50;
                        document.getElementById('ratio-display').textContent = (config.post_visit_ratio || 50) + '%';
                        document.getElementById('max-posts').value = config.max_posts_per_run || 10;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ ¸å¿ƒå‚æ•°å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½è®¿é—®æ§åˆ¶é…ç½®
        function loadVisitControl() {
            if (!currentDeviceId) return;
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.visit_control) {
                        const visitControl = data.data.visit_control;
                        // æ›´æ–°è®¿é—®æ§åˆ¶è¡¨å•
                        document.getElementById('filter-image-text').checked = visitControl.filter_image_text || true;
                        document.getElementById('duration-min').value = visitControl.duration_range ? visitControl.duration_range[0] : 25;
                        document.getElementById('duration-max').value = visitControl.duration_range ? visitControl.duration_range[1] : 45;
                        document.getElementById('slide-distance').value = visitControl.slide_distance || 'single_image';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è®¿é—®æ§åˆ¶é…ç½®å¤±è´¥:', error);
                });
        }

        // åˆ·æ–°å…³é”®è¯åˆ—è¡¨
        function refreshKeywords() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            fetch(`/api/config/keywords/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const keywordList = document.getElementById('keyword-list');
                        keywordList.innerHTML = '';
                        data.data.forEach(keyword => {
                            const listItem = document.createElement('div');
                            listItem.className = 'list-item';
                            listItem.innerHTML = `
                                <div class="list-item-content">
                                    <div class="list-item-text">${keyword}</div>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="deleteKeyword('${keyword}')">åˆ é™¤</button>
                                </div>
                            `;
                            keywordList.appendChild(listItem);
                        });
                    } else {
                        alert('è·å–å…³é”®è¯åˆ—è¡¨å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ·»åŠ å…³é”®è¯
        function addKeyword() {
            const newKeyword = document.getElementById('new-keyword').value.trim();
            if (!newKeyword) {
                alert('è¯·è¾“å…¥å…³é”®è¯');
                return;
            }
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            // å…ˆè·å–ç°æœ‰å…³é”®è¯åˆ—è¡¨
            fetch(`/api/config/keywords/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const keywords = data.data;
                        // æ£€æŸ¥å…³é”®è¯æ˜¯å¦å·²å­˜åœ¨
                        if (keywords.includes(newKeyword)) {
                            alert('å…³é”®è¯å·²å­˜åœ¨');
                            return;
                        }
                        // æ·»åŠ æ–°å…³é”®è¯
                        keywords.push(newKeyword);
                        // ä¿å­˜å®Œæ•´åˆ—è¡¨
                        return fetch(`/api/config/keywords/${currentDeviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ keywords: keywords })
                        });
                    } else {
                        throw new Error('è·å–å…³é”®è¯åˆ—è¡¨å¤±è´¥');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshKeywords();
                        document.getElementById('new-keyword').value = '';
                        alert('å…³é”®è¯æ·»åŠ æˆåŠŸ');
                    } else {
                        alert('æ·»åŠ å…³é”®è¯å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // æ‰¹é‡å¯¼å…¥å…³é”®è¯
        function importKeywords() {
            const importText = document.getElementById('keywords-import').value.trim();
            if (!importText) {
                alert('è¯·è¾“å…¥å…³é”®è¯');
                return;
            }
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            const keywords = importText.split('\n').map(line => line.trim()).filter(line => line);
            fetch(`/api/config/keywords/${currentDeviceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ keywords: keywords })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshKeywords();
                    document.getElementById('keywords-import').value = '';
                    alert('å…³é”®è¯å¯¼å…¥æˆåŠŸ');
                } else {
                    alert('å¯¼å…¥å…³é”®è¯å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }

        // åˆ é™¤å…³é”®è¯
        function deleteKeyword(keyword) {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            fetch(`/api/config/keywords/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const keywords = data.data.filter(k => k !== keyword);
                        return fetch(`/api/config/keywords/${currentDeviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ keywords: keywords })
                        });
                    } else {
                        throw new Error('è·å–å…³é”®è¯åˆ—è¡¨å¤±è´¥');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshKeywords();
                    } else {
                        alert('åˆ é™¤å…³é”®è¯å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // ä¿å­˜æ ¸å¿ƒå‚æ•°
        function saveParams() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            const params = {
                duration_minutes: parseInt(document.getElementById('duration-minutes').value),
                post_visit_ratio: parseInt(document.getElementById('post-visit-ratio').value),
                max_posts_per_run: parseInt(document.getElementById('max-posts').value)
            };
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = { ...data.data, ...params };
                        return fetch(`/api/config/${currentDeviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(config)
                        });
                    } else {
                        throw new Error('è·å–é…ç½®å¤±è´¥');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('å‚æ•°ä¿å­˜æˆåŠŸ');
                    } else {
                        alert('ä¿å­˜å‚æ•°å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // ä¿å­˜è®¿é—®æ§åˆ¶é…ç½®
        function saveVisitControl() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            const visitControl = {
                filter_image_text: document.getElementById('filter-image-text').checked,
                duration_range: [
                    parseInt(document.getElementById('duration-min').value),
                    parseInt(document.getElementById('duration-max').value)
                ],
                slide_interval: [3, 5], // é»˜è®¤å€¼
                slide_distance: document.getElementById('slide-distance').value
            };
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = { ...data.data, visit_control: visitControl };
                        return fetch(`/api/config/${currentDeviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(config)
                        });
                    } else {
                        throw new Error('è·å–é…ç½®å¤±è´¥');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('è®¿é—®æ§åˆ¶é…ç½®ä¿å­˜æˆåŠŸ');
                    } else {
                        alert('ä¿å­˜è®¿é—®æ§åˆ¶é…ç½®å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // è¯„è®ºæ¨¡æ¿ç®¡ç†
        let commentTemplates = ['ä¸é”™çš„åˆ†äº«ï¼', 'å­¦ä¹ äº†~', 'æ„Ÿè°¢åˆ†äº«', 'å¾ˆæœ‰ç”¨çš„å†…å®¹', 'å·²æ”¶è—å­¦ä¹ '];

        // åŠ è½½è¯„è®ºæ¨¡æ¿
        function loadCommentTemplates() {
            if (!currentDeviceId) return;
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.interaction) {
                        commentTemplates = data.data.interaction.comment_templates || commentTemplates;
                        renderCommentTemplates();
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è¯„è®ºæ¨¡æ¿å¤±è´¥:', error);
                });
        }

        // æ¸²æŸ“è¯„è®ºæ¨¡æ¿åˆ—è¡¨
        function renderCommentTemplates() {
            const listContainer = document.getElementById('comment-templates-list');
            listContainer.innerHTML = '';
            
            if (commentTemplates.length === 0) {
                listContainer.innerHTML = '<div style="color: #999; padding: 20px;">æš‚æ— è¯„è®ºæ¨¡æ¿ï¼Œè¯·æ·»åŠ </div>';
                return;
            }
            
            commentTemplates.forEach((template, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-text">${template}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteCommentTemplate(${index})">åˆ é™¤</button>
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
        }

        // æ·»åŠ è¯„è®ºæ¨¡æ¿
        function addCommentTemplate() {
            const newTemplate = document.getElementById('new-template').value.trim();
            if (!newTemplate) {
                alert('è¯·è¾“å…¥è¯„è®ºæ¨¡æ¿');
                return;
            }
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            if (commentTemplates.includes(newTemplate)) {
                alert('è¯„è®ºæ¨¡æ¿å·²å­˜åœ¨');
                return;
            }
            
            commentTemplates.push(newTemplate);
            renderCommentTemplates();
            document.getElementById('new-template').value = '';
            alert('è¯„è®ºæ¨¡æ¿æ·»åŠ æˆåŠŸ');
        }

        // åˆ é™¤è¯„è®ºæ¨¡æ¿
        function deleteCommentTemplate(index) {
            if (commentTemplates.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€æ¡è¯„è®ºæ¨¡æ¿');
                return;
            }
            commentTemplates.splice(index, 1);
            renderCommentTemplates();
        }

        // ä¿å­˜äº’åŠ¨é…ç½®
        function saveInteraction() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            if (commentTemplates.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡è¯„è®ºæ¨¡æ¿');
                return;
            }
            const interaction = {
                like_prob: parseInt(document.getElementById('like-prob').value),
                collect_prob: parseInt(document.getElementById('collect-prob').value),
                comment_prob: parseInt(document.getElementById('comment-prob').value),
                comment_templates: commentTemplates
            };
            fetch(`/api/config/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = { ...data.data, interaction: interaction };
                        return fetch(`/api/config/${currentDeviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(config)
                        });
                    } else {
                        throw new Error('è·å–é…ç½®å¤±è´¥');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('äº’åŠ¨é…ç½®ä¿å­˜æˆåŠŸ');
                    } else {
                        alert('ä¿å­˜äº’åŠ¨é…ç½®å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                });
        }

        // å¯åŠ¨å…»å·
        function startYangHao() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            fetch('/api/yanghao/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ device_id: currentDeviceId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å…»å·å·²å¯åŠ¨');
                    setInterval(refreshStatus, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
                } else {
                    alert('å¯åŠ¨å…»å·å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }

        // åœæ­¢å…»å·
        function stopYangHao() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            fetch('/api/yanghao/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ device_id: currentDeviceId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å…»å·å·²åœæ­¢');
                    refreshStatus();
                } else {
                    alert('åœæ­¢å…»å·å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            });
        }

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            if (!currentDeviceId) {
                return;
            }
            fetch(`/api/yanghao/status/${currentDeviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const status = data.data;
                        // æ›´æ–°ä»ªè¡¨æ¿çŠ¶æ€
                        document.getElementById('running-status').textContent = status.is_running ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'âšª æœªè¿è¡Œ';
                        document.getElementById('visited-count').textContent = status.visited || 0;
                        document.getElementById('remain-time').textContent = (status.remain_time || 0) + ' åˆ†é’Ÿ';
                        // æ›´æ–°çŠ¶æ€é¡µé¢
                        document.getElementById('connection-status').textContent = status.connection_status || 'æœªè¿æ¥';
                        document.getElementById('current-keyword').textContent = status.current_keyword || 'æ— ';
                        document.getElementById('status-visited-count').textContent = status.visited || 0;
                        document.getElementById('status-remain-time').textContent = (status.remain_time || 0) + ' åˆ†é’Ÿ';
                    }
                })
                .catch(error => {
                    console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
                });
        }

        // ä¿å­˜å…³é”®è¯
        function saveKeywords() {
            if (!currentDeviceId) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            // åˆ·æ–°å…³é”®è¯åˆ—è¡¨ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„å…³é”®è¯
            refreshKeywords();
            alert('å…³é”®è¯å·²ä¿å­˜');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
            refreshDevices();
            // åˆ·æ–°çŠ¶æ€
            refreshStatus();
        };
    </script>
</body>
</html>