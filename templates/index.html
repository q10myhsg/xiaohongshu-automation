ç°åœ¨æˆ‘ä¸ºä½ ç”Ÿæˆå®Œæ•´çš„é¡¹ç›®ä»£ç ç»“æ„å’Œå®ç°ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäº **UIAutomator2 + Flask + HTML** çš„å°çº¢ä¹¦è‡ªåŠ¨åŒ–å·¥å…·ã€‚

## ğŸ“ é¡¹ç›®å®Œæ•´ç»“æ„

```
xiaohongshu-automation/
â”œâ”€â”€ app.py                      # Flask ä¸»æœåŠ¡
â”œâ”€â”€ device_control.py           # è®¾å¤‡/å…»å·æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ config_manager.py           # é…ç½®ç®¡ç†æ¨¡å—
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.json             # è®¾å¤‡ä¸ªæ€§åŒ–é…ç½®
â”œâ”€â”€ static/
â”‚   â””â”€â”€ style.css               # å‰ç«¯æ ·å¼
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ index.html              # å…¥å£/ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ device.html             # è®¾å¤‡ç®¡ç†
â”‚   â”œâ”€â”€ keyword. html            # å…³é”®è¯ç®¡ç†
â”‚   â”œâ”€â”€ param.html              # æ ¸å¿ƒå‚æ•°é…ç½®
â”‚   â”œâ”€â”€ visit.html              # è®¿é—®æ§åˆ¶
â”‚   â”œâ”€â”€ interact.html           # äº’åŠ¨é…ç½®
â”‚   â””â”€â”€ status.html             # çŠ¶æ€ç›‘æ§
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
```

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶å®ç°

### 1. **Flask ä¸»æœåŠ¡** (`app.py`)

```python name=app.py
from flask import Flask, request, jsonify, render_template
import json
import threading
import os
from device_control import (
    get_devices,
    switch_device,
    run_yanghao,
    stop_yanghao,
    device_status,
    get_default_config
)
from config_manager import ConfigManager

app = Flask(__name__, template_folder='templates', static_folder='static')

# åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
config_manager = ConfigManager("config/config.json")
current_device = {"device_id": None}

# ==================== é¡µé¢è·¯ç”± ====================
@app. route("/")
def index():
    """ä¸»é¡µä»ªè¡¨æ¿"""
    return render_template("index.html")

@app.route("/device")
def device_page():
    """è®¾å¤‡ç®¡ç†é¡µé¢"""
    return render_template("device.html")

@app.route("/keyword")
def keyword_page():
    """å…³é”®è¯ç®¡ç†é¡µé¢"""
    return render_template("keyword. html")

@app.route("/param")
def param_page():
    """æ ¸å¿ƒå‚æ•°é¡µé¢"""
    return render_template("param.html")

@app.route("/visit")
def visit_page():
    """è®¿é—®æ§åˆ¶é¡µé¢"""
    return render_template("visit.html")

@app.route("/interact")
def interact_page():
    """äº’åŠ¨é…ç½®é¡µé¢"""
    return render_template("interact.html")

@app.route("/status")
def status_page():
    """çŠ¶æ€ç›‘æ§é¡µé¢"""
    return render_template("status.html")

# ==================== API æ¥å£ ====================

@app.route("/api/devices", methods=["GET"])
def api_devices():
    """è·å–å·²è¿æ¥è®¾å¤‡åˆ—è¡¨"""
    try:
        devices = get_devices()
        return jsonify({"success": True, "data": devices})
    except Exception as e:
        return jsonify({"success": False, "error":  str(e)})

@app.route("/api/device/switch", methods=["POST"])
def api_device_switch():
    """åˆ‡æ¢è®¾å¤‡"""
    try: 
        device_id = request.json.get("device_id")
        if not device_id: 
            return jsonify({"success":  False, "error": "è®¾å¤‡IDä¸èƒ½ä¸ºç©º"})
        
        # å¦‚æœæœ‰å…¶ä»–è®¾å¤‡åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
        if current_device["device_id"]:
            stop_yanghao(current_device["device_id"])
        
        result = switch_device(device_id)
        if result: 
            current_device["device_id"] = device_id
            # åˆå§‹åŒ–æ–°è®¾å¤‡é…ç½®ï¼ˆå¦‚æ— åˆ™å¤åˆ¶é»˜è®¤é…ç½®ï¼‰
            if not config_manager.get_config(device_id):
                default_cfg = get_default_config()
                config_manager.save_config(device_id, default_cfg)
            return jsonify({"success": True, "message": f"å·²åˆ‡æ¢åˆ°è®¾å¤‡:  {device_id}"})
        else:
            return jsonify({"success": False, "error":  "è®¾å¤‡è¿æ¥å¤±è´¥"})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/config/<device_id>", methods=["GET"])
def api_get_config(device_id):
    """è·å–è®¾å¤‡é…ç½®"""
    try:
        config = config_manager.get_config(device_id)
        if not config:
            config = get_default_config()
        return jsonify({"success":  True, "data": config})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/config/<device_id>", methods=["PUT"])
def api_save_config(device_id):
    """ä¿å­˜è®¾å¤‡é…ç½®"""
    try:
        config = request.json
        config_manager.save_config(device_id, config)
        return jsonify({"success": True, "message": "é…ç½®å·²ä¿å­˜"})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/config/keywords/<device_id>", methods=["GET", "PUT"])
def api_keywords(device_id):
    """ç®¡ç†å…³é”®è¯"""
    try:
        if request.method == "GET": 
            config = config_manager.get_config(device_id)
            keywords = config.get("keywords", []) if config else []
            return jsonify({"success": True, "data": keywords})
        else:
            keywords = request.json.get("keywords", [])
            config = config_manager.get_config(device_id)
            config["keywords"] = keywords
            config_manager.save_config(device_id, config)
            return jsonify({"success": True, "message": "å…³é”®è¯å·²æ›´æ–°"})
    except Exception as e:
        return jsonify({"success": False, "error":  str(e)})

# ==================== å…»å·æ§åˆ¶ ====================

@app.route("/api/yanghao/start", methods=["POST"])
def api_start_yanghao():
    """å¯åŠ¨å…»å·"""
    try: 
        device_id = request. json.get("device_id") or current_device["device_id"]
        if not device_id:
            return jsonify({"success": False, "error": "æœªé€‰æ‹©è®¾å¤‡"})
        
        config = config_manager.get_config(device_id)
        if not config:
            return jsonify({"success": False, "error": "é…ç½®ä¸å®Œæ•´"})
        
        if not config.get("keywords"):
            return jsonify({"success": False, "error": "è¯·å…ˆæ·»åŠ æœç´¢å…³é”®è¯"})
        
        # å¯åŠ¨å…»å·çº¿ç¨‹
        threading.Thread(
            target=run_yanghao,
            args=(device_id, config),
            daemon=True
        ).start()
        
        return jsonify({"success": True, "message": "å…»å·å·²å¯åŠ¨"})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/yanghao/stop", methods=["POST"])
def api_stop_yanghao():
    """åœæ­¢å…»å·"""
    try: 
        device_id = request.json.get("device_id") or current_device["device_id"]
        if not device_id: 
            return jsonify({"success": False, "error": "æœªé€‰æ‹©è®¾å¤‡"})
        
        stop_yanghao(device_id)
        return jsonify({"success": True, "message": "å·²åœæ­¢å…»å·"})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/yanghao/status/<device_id>")
def api_status(device_id):
    """è·å–å…»å·çŠ¶æ€"""
    try:
        status = device_status(device_id)
        return jsonify({"success": True, "data": status})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)})

@app.route("/api/config/default", methods=["GET", "PUT"])
def api_default_config():
    """ç®¡ç†é»˜è®¤é…ç½®æ¨¡æ¿"""
    try:
        if request.method == "GET": 
            default_cfg = config_manager.get_default_template()
            return jsonify({"success": True, "data": default_cfg})
        else:
            cfg = request.json
            config_manager.set_default_template(cfg)
            return jsonify({"success":  True, "message": "é»˜è®¤æ¨¡æ¿å·²æ›´æ–°"})
    except Exception as e:
        return jsonify({"success": False, "error":  str(e)})

# ==================== é”™è¯¯å¤„ç† ====================

@app.errorhandler(404)
def not_found(error):
    return jsonify({"success": False, "error": "è¯·æ±‚ä¸å­˜åœ¨"}), 404

@app.errorhandler(500)
def server_error(error):
    return jsonify({"success": False, "error": "æœåŠ¡å™¨é”™è¯¯"}), 500

if __name__ == '__main__':
    # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
    os.makedirs("config", exist_ok=True)
    if not os.path.exists("config/config.json"):
        with open("config/config.json", "w", encoding="utf-8") as f:
            json.dump({}, f, indent=2, ensure_ascii=False)
    
    app.run(host="0.0.0.0", port=5000, debug=True, threaded=True)
```

---

### 2. **è®¾å¤‡æ§åˆ¶ & å…»å·é€»è¾‘** (`device_control.py`)

```python name=device_control.py
import uiautomator2 as u2
import random
import time
import logging
from typing import Dict, List, Optional

# æ—¥å¿—é…ç½®
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# å…¨å±€è®¾å¤‡çŠ¶æ€
_devices_pool:  Dict[str, u2.Device] = {}
_status:  Dict[str, dict] = {}
_stop_flag: Dict[str, bool] = {}

# ==================== è®¾å¤‡ç®¡ç† ====================

def get_devices() -> List[Dict]:
    """è·å–å·²è¿æ¥çš„ADBè®¾å¤‡åˆ—è¡¨"""
    try:
        devices = u2.adb. device_list()
        device_list = []
        for device in devices:
            # å°è¯•è¿æ¥å¹¶è·å–è®¾å¤‡ä¿¡æ¯
            try:
                d = u2.connect(device)
                info = d.info
                device_list.append({
                    "id": device,
                    "name": f"{info.get('model', 'Unknown')}({device})",
                    "status":  "online"
                })
            except: 
                device_list.append({
                    "id": device,
                    "name": device,
                    "status": "offline"
                })
        return device_list
    except Exception as e:
        logger.error(f"è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: {e}")
        return []

def switch_device(device_id: str) -> bool:
    """åˆ‡æ¢åˆ°æŒ‡å®šè®¾å¤‡"""
    try:
        if device_id in _devices_pool:
            del _devices_pool[device_id]
        
        d = u2.connect(device_id)
        _devices_pool[device_id] = d
        _status[device_id] = {
            "is_running": False,
            "remain_time": 0,
            "visited":  0,
            "current_keyword": "",
            "connection_status": "online"
        }
        _stop_flag[device_id] = False
        logger.info(f"å·²è¿æ¥è®¾å¤‡: {device_id}")
        return True
    except Exception as e:
        logger. error(f"è¿æ¥è®¾å¤‡å¤±è´¥: {e}")
        return False

def device_status(device_id: str) -> dict:
    """è·å–è®¾å¤‡çŠ¶æ€"""
    return _status.get(device_id, {
        "is_running": False,
        "remain_time": 0,
        "visited": 0,
        "connection_status": "offline"
    })

def stop_yanghao(device_id:  str):
    """åœæ­¢å…»å·"""
    _stop_flag[device_id] = True
    logger.info(f"å·²è¯·æ±‚åœæ­¢è®¾å¤‡ {device_id} çš„å…»å·")

# ==================== é»˜è®¤é…ç½® ====================

def get_default_config() -> dict:
    """è·å–é»˜è®¤é…ç½®"""
    return {
        "keywords": ["ç§‘æŠ€èµ„è®¯", "æ—…è¡Œæ”»ç•¥", "ç¾é£Ÿæ•™ç¨‹"],
        "duration_minutes": 20,
        "post_visit_ratio": 50,
        "max_posts_per_run": 10,
        "visit_control": {
            "filter_image_text": True,
            "duration_range": [25, 45],
            "slide_interval": [3, 5],
            "slide_distance":  "single_image"
        },
        "interaction": {
            "like_prob": 15,
            "collect_prob": 10,
            "comment_prob": 5,
            "comment_templates": [
                "ä¸é”™çš„åˆ†äº«ï¼",
                "å­¦ä¹ äº†~",
                "æ„Ÿè°¢åˆ†äº«",
                "å¾ˆæœ‰ç”¨çš„å†…å®¹",
                "å·²æ”¶è—å­¦ä¹ "
            ]
        }
    }

# ==================== å…»å·ä¸»æµç¨‹ ====================

def run_yanghao(device_id: str, config: dict):
    """æ‰§è¡Œå…»å·æµç¨‹"""
    try:
        if device_id not in _devices_pool:
            logger.error(f"è®¾å¤‡ {device_id} æœªè¿æ¥")
            return
        
        d = _devices_pool[device_id]
        total_time = config['duration_minutes'] * 60
        visited = 0
        max_posts = config['max_posts_per_run']
        
        _status[device_id] = {
            "is_running": True,
            "remain_time":  config['duration_minutes'],
            "visited": 0,
            "connection_status": "online"
        }
        
        logger.info(f"å¼€å§‹å…»å· - è®¾å¤‡: {device_id}, æ—¶é•¿: {config['duration_minutes']}åˆ†é’Ÿ")
        
        t0 = time.time()
        
        while time.time() - t0 < total_time and visited < max_posts:
            if _stop_flag. get(device_id, False):
                logger.info(f"å…»å·å·²åœæ­¢ - è®¾å¤‡: {device_id}")
                break
            
            # éšæœºé€‰æ‹©å…³é”®è¯
            keywords = config. get('keywords', [])
            if not keywords:
                logger.warning("å…³é”®è¯åˆ—è¡¨ä¸ºç©º")
                break
            
            keyword = random.choice(keywords)
            _status[device_id]["current_keyword"] = keyword
            
            # æ‰“å¼€å°çº¢ä¹¦æœç´¢æ¡†
            logger.info(f"æœç´¢å…³é”®è¯: {keyword}")
            _search_and_visit_posts(d, keyword, config, device_id, total_time - (time.time() - t0))
            
            visited = _status[device_id]['visited']
            remain_time = int((total_time - (time.time() - t0)) / 60)
            _status[device_id]["remain_time"] = max(0, remain_time)
            
            # é•¿éšæœºé—´éš”ï¼ˆé¿å…é¢‘ç¹æ“ä½œï¼‰
            wait_time = random.randint(30, 60)
            logger.info(f"ç­‰å¾… {wait_time} ç§’åç»§ç»­")
            time.sleep(wait_time)
        
        # å…»å·å®Œæˆ
        logger.info(f"å…»å·å®Œæˆ - è®¾å¤‡: {device_id}, è®¿é—®å¸–å­æ•°: {visited}")
        _status[device_id] = {
            "is_running": False,
            "remain_time": 0,
            "visited": visited,
            "connection_status":  "online"
        }
        _stop_flag[device_id] = False
        
    except Exception as e:
        logger.error(f"å…»å·å¼‚å¸¸ - è®¾å¤‡: {device_id}, é”™è¯¯: {e}")
        _status[device_id]["is_running"] = False

def _search_and_visit_posts(d:  u2.Device, keyword: str, config: dict, device_id: str, remain_time: float):
    """æœç´¢å¹¶è®¿é—®å¸–å­"""
    try: 
        # 1. æ‰“å¼€æœç´¢æ¡† (éœ€æ ¹æ®å®é™…UIè°ƒæ•´)
        # å‡è®¾å­˜åœ¨æœç´¢æŒ‰é’®æˆ–æœç´¢æ¡†
        d.press("home")  # å›åˆ°é¦–é¡µ
        time.sleep(random.randint(2, 4))
        
        # ç‚¹å‡»æœç´¢æ¡† - ç¤ºä¾‹é€‰æ‹©å™¨ï¼ˆéœ€æ ¹æ®å®é™…APPè°ƒæ•´ï¼‰
        search_box = d(resourceId="com.xingin.xhs: id/search_bar", focusable=True)
        if search_box. exists:
            search_box. click()
            time.sleep(random.randint(1, 2))
        else:
            logger.warning("æœç´¢æ¡†æœªæ‰¾åˆ°")
            return
        
        # 2. è¾“å…¥å…³é”®è¯
        d. send_keys(keyword)
        time.sleep(random.randint(1, 2))
        
        # æŒ‰æœç´¢æŒ‰é’®æˆ–å›è½¦
        d.press("enter")
        time.sleep(random.randint(2, 4))
        
        # 3. æ»šåŠ¨å¹¶è®¿é—®å¸–å­
        post_visit_ratio = config['post_visit_ratio'] / 100.0
        max_posts = config['max_posts_per_run']
        duration_range = config['visit_control']['duration_range']
        
        visited_count = 0
        scroll_count = 0
        max_scrolls = int(max_posts / post_visit_ratio) + 5
        
        while visited_count < max_posts and scroll_count < max_scrolls:
            if _stop_flag.get(device_id, False):
                break
            
            # éšæœºå†³å®šæ˜¯å¦è®¿é—®æœ¬å¸–å­
            if random.random() < post_visit_ratio:
                # ç‚¹å‡»ç¬¬ä¸€ä¸ªå¯è§çš„å¸–å­
                posts = d(className="android.view.View")
                if posts.exists:
                    post_item = posts[0] if len(posts) > 0 else None
                    if post_item:
                        try:
                            post_item.click()
                            time.sleep(random.randint(2, 3))
                            
                            # 4. è®¿é—®å¸–å­è¯¦æƒ…
                            _visit_post_detail(d, config, device_id, duration_range)
                            visited_count += 1
                            _status[device_id]["visited"] = visited_count
                            
                            # è¿”å›åˆ—è¡¨
                            d.press("back")
                            time.sleep(random.randint(2, 3))
                        except Exception as e:
                            logger.error(f"è®¿é—®å¸–å­å¤±è´¥: {e}")
                            d.press("back")
            
            # æ»‘åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¸–å­
            d.swipe(500, 1000, 500, 300, duration=0.5)  # ä¸Šæ»‘
            time.sleep(random.randint(1, 3))
            scroll_count += 1
    
    except Exception as e: 
        logger.error(f"æœç´¢è®¿é—®å¤±è´¥: {e}")

def _visit_post_detail(d: u2.Device, config: dict, device_id: str, duration_range: List[int]):
    """è®¿é—®å¸–å­è¯¦æƒ…å¹¶æ‰§è¡Œäº’åŠ¨"""
    try:
        # éšæœºè®¿é—®æ—¶é•¿
        visit_duration = random.randint(duration_range[0], duration_range[1])
        logger.info(f"è®¿é—®å¸–å­è¯¦æƒ…ï¼Œé¢„è®¡åœç•™ {visit_duration} ç§’")
        
        visit_start = time.time()
        slide_interval = config['visit_control']['slide_interval']
        
        # 5. æ¨¡æ‹Ÿæµè§ˆï¼šéšæœºæ»‘åŠ¨å›¾ç‰‡
        while time.time() - visit_start < visit_duration:
            if _stop_flag.get(device_id, False):
                break
            
            # æ¯éš”3-5ç§’æ»‘åŠ¨ä¸€æ¬¡
            wait_before_slide = random.randint(slide_interval[0], slide_interval[1])
            time.sleep(min(wait_before_slide, visit_duration - (time.time() - visit_start)))
            
            if time.time() - visit_start < visit_duration:
                # ä¸Šæ»‘å›¾ç‰‡
                d.swipe(500, 1000, 500, 300, duration=0.3)
                time.sleep(random.randint(1, 2))
        
        # 6. æ‰§è¡Œäº’åŠ¨è¡Œä¸º
        interaction_cfg = config['interaction']
        
        # ç‚¹èµ
        if random.randint(1, 100) <= interaction_cfg['like_prob']:
            _do_like(d)
        
        # æ”¶è—
        if random.randint(1, 100) <= interaction_cfg['collect_prob']: 
            _do_collect(d)
        
        # è¯„è®º
        if random.randint(1, 100) <= interaction_cfg['comment_prob']: 
            comments = interaction_cfg['comment_templates']
            comment_text = random.choice(comments)
            _do_comment(d, comment_text)
        
    except Exception as e:
        logger.error(f"è®¿é—®å¸–å­è¯¦æƒ…å¤±è´¥: {e}")

def _do_like(d: u2.Device):
    """æ‰§è¡Œç‚¹èµ"""
    try:
        like_btn = d(resourceId="com.xingin.xhs:id/like_btn", clickable=True)
        if like_btn.exists:
            like_btn.click()
            logger.info("å·²ç‚¹èµ")
            time.sleep(random.randint(1, 2))
    except Exception as e: 
        logger.error(f"ç‚¹èµå¤±è´¥: {e}")

def _do_collect(d: u2.Device):
    """æ‰§è¡Œæ”¶è—"""
    try:
        collect_btn = d(resourceId="com.xingin.xhs:id/collect_btn", clickable=True)
        if collect_btn.exists:
            collect_btn.click()
            logger.info("å·²æ”¶è—")
            time.sleep(random.randint(1, 2))
    except Exception as e:
        logger.error(f"æ”¶è—å¤±è´¥: {e}")

def _do_comment(d: u2.Device, comment_text: str):
    """æ‰§è¡Œè¯„è®º"""
    try:
        comment_btn = d(resourceId="com.xingin.xhs:id/comment_btn", clickable=True)
        if comment_btn.exists:
            comment_btn.click()
            time.sleep(random.randint(1, 2))
            
            comment_input = d(resourceId="com. xingin.xhs:id/comment_input_field")
            if comment_input.exists:
                comment_input.set_text(comment_text)
                time.sleep(random.randint(1, 2))
                
                send_btn = d(resourceId="com.xingin.xhs:id/comment_send_btn", clickable=True)
                if send_btn.exists:
                    send_btn.click()
                    logger.info(f"å·²è¯„è®º: {comment_text}")
                    time.sleep(random.randint(1, 2))
    except Exception as e:
        logger.error(f"è¯„è®ºå¤±è´¥: {e}")
```

---

### 3. **é…ç½®ç®¡ç†** (`config_manager.py`)

```python name=config_manager.py
import json
import os
from typing import Dict, Optional
import logging

logger = logging.getLogger(__name__)

class ConfigManager:
    """é…ç½®æ–‡ä»¶ç®¡ç†ç±»"""
    
    def __init__(self, config_path: str):
        self.config_path = config_path
        self.ensure_config_exists()
    
    def ensure_config_exists(self):
        """ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨"""
        os.makedirs(os.path. dirname(self.config_path), exist_ok=True)
        if not os.path.exists(self.config_path):
            with open(self.config_path, 'w', encoding='utf-8') as f:
                json. dump({}, f, indent=2, ensure_ascii=False)
    
    def load_config(self) -> Dict:
        """è¯»å–æ•´ä¸ªé…ç½®æ–‡ä»¶"""
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            logger.error(f"è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
            return {}
    
    def save_config_file(self, data: Dict):
        """ä¿å­˜æ•´ä¸ªé…ç½®æ–‡ä»¶"""
        try:
            with open(self.config_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
            logger.info("é…ç½®æ–‡ä»¶å·²ä¿å­˜")
        except Exception as e: 
            logger.error(f"ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥:  {e}")
    
    def get_config(self, device_id: str) -> Optional[Dict]:
        """è·å–æŒ‡å®šè®¾å¤‡çš„é…ç½®"""
        config = self.load_config()
        return config.get(device_id)
    
    def save_config(self, device_id: str, config: Dict):
        """ä¿å­˜æŒ‡å®šè®¾å¤‡çš„é…ç½®"""
        data = self.load_config()
        data[device_id] = config
        self.save_config_file(data)
    
    def get_default_template(self) -> Dict:
        """è·å–é»˜è®¤é…ç½®æ¨¡æ¿"""
        config = self.load_config()
        return config.get("_default", self._create_default_template())
    
    def set_default_template(self, template: Dict):
        """è®¾ç½®é»˜è®¤é…ç½®æ¨¡æ¿"""
        config = self.load_config()
        config["_default"] = template
        self.save_config_file(config)
    
    def _create_default_template(self) -> Dict:
        """åˆ›å»ºé»˜è®¤æ¨¡æ¿"""
        return {
            "keywords": ["ç§‘æŠ€èµ„è®¯", "æ—…è¡Œæ”»ç•¥", "ç¾é£Ÿæ•™ç¨‹"],
            "duration_minutes": 20,
            "post_visit_ratio": 50,
            "max_posts_per_run": 10,
            "visit_control": {
                "filter_image_text": True,
                "duration_range": [25, 45],
                "slide_interval": [3, 5],
                "slide_distance":  "single_image"
            },
            "interaction": {
                "like_prob": 15,
                "collect_prob": 10,
                "comment_prob": 5,
                "comment_templates": [
                    "ä¸é”™çš„åˆ†äº«ï¼",
                    "å­¦ä¹ äº†~",
                    "æ„Ÿè°¢åˆ†äº«"
                ]
            }
        }
```

---

### 4. **å‰ç«¯æ ·å¼** (`static/style.css`)

```css name=static/style.css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background:  linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

. container {
    max-width:  1200px;
    margin: 0 auto;
    padding: 20px;
}

/* å¯¼èˆªæ  */
.navbar {
    background: white;
    padding: 0;
    margin-bottom: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.navbar-brand {
    padding: 20px 30px;
    font-size:  24px;
    font-weight:  bold;
    color: #667eea;
}

.navbar-nav {
    display: flex;
    list-style: none;
    flex-wrap: wrap;
}

.nav-item {
    border-bottom: 3px solid transparent;
}

.nav-link {
    display: block;
    padding: 15px 20px;
    text-decoration: none;
    color: #333;
    transition:  all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

/* ä¸»å†…å®¹åŒº */
.main-content {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.page {
    display: none;
}

.page.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* æ ‡é¢˜ */
h1, h2, h3 {
    color: #333;
    margin-bottom: 20px;
}

h1 {
    font-size: 32px;
    border-bottom: 3px solid #667eea;
    padding-bottom: 15px;
}

h2 {
    font-size: 24px;
    margin-top: 20px;
}

/* è¡¨å•å…ƒç´  */
. form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight:  500;
    color: #333;
}

input[type="text"],
input[type="number"],
textarea,
select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

input[type="text"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #ddd;
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]: :-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* æŒ‰é’® */
button, . btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition:  all 0.3s ease;
    display: inline-block;
    text-decoration: none;
}

. btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: #48bb78;
    color: white;
}

.btn-success:hover {
    background: #38a169;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
}

.btn-danger {
    background: #f56565;
    color: white;
}

.btn-danger:hover {
    background: #e53e3e;
    transform:  translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
}

. btn-warning {
    background:  #ed8936;
    color: white;
}

.btn-warning:hover {
    background: #dd6b20;
}

. btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

/* åˆ—è¡¨æ ·å¼ */
.list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border:  1px solid #eee;
    border-radius:  5px;
    margin-bottom: 10px;
    background: #f9fafb;
    transition: all 0.3s ease;
}

.list-item:hover {
    background:  #f0f4ff;
    border-color: #667eea;
}

.list-item-content {
    flex: 1;
}

.list-item-text {
    color: #333;
    font-weight: 500;
}

. list-item-actions {
    display: flex;
    gap:  8px;
}

/* çŠ¶æ€å¡ç‰‡ */
.status-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.status-label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 5px;
}

.status-value {
    font-size: 24px;
    font-weight: bold;
}

/* è®¾å¤‡é€‰æ‹©æ¡† */
.device-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.device-option {
    position: relative;
}

.device-option input[type="radio"] {
    display: none;
}

.device-option label {
    display:  block;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    margin-bottom: 0;
}

.device-option input[type="radio"]:checked + label {
    border-color: #667eea;
    background: #f0f4ff;
    color: #667eea;
}

/* è¿›åº¦æ¡ */
.progress {
    width: 100%;
    height:  10px;
    background: #eee;
    border-radius:  5px;
    overflow:  hidden;
    margin:  10px 0;
}

. progress-bar {
    height:  100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s ease;
}

/* è­¦å‘Šæ¡† */
.alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-info {
    background: #e6f2ff;
    border-left: 4px solid #2196F3;
    color: #1565c0;
}

.alert-warning {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    color: #856404;
}

.alert-danger {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    color: #721c24;
}

. alert-success {
    background:  #d4edda;
    border-left: 4px solid #28a745;
    color: #155724;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .main-content {
        padding: 15px;
    }
    
    h1 {
        font-size: 24px;
    }
    
    . navbar-nav {
        flex-direction: column;
    }
    
    .device-selector {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    button, .btn {
        width: 100%;
    }
}
```

---

### 5. **HTML é¡µé¢** (ä¸»å…¥å£ - `templates/index.html`)

```html name=templates/index.html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦è‡ªåŠ¨åŒ– - æ™ºèƒ½å…»å·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-brand">ğŸš€ å°çº¢ä¹¦è‡ªåŠ¨åŒ–ç³»ç»Ÿ</div>
        <ul class="navbar-nav">
            <li class="nav-item"><a href="#" class="nav-link active" onclick="showPage('dashboard')">ä»ªè¡¨æ¿</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('device')">è®¾å¤‡ç®¡ç†</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('keyword')">å…³é”®è¯</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('param')">æ ¸å¿ƒå‚æ•°</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('visit')">è®¿é—®æ§åˆ¶</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('interact')">äº’åŠ¨é…ç½®</a></li>
            <li class="nav-item"><a href="#" class="nav-link" onclick="showPage('status')">å®æ—¶çŠ¶æ€</a></li>
        </ul>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <div class="main-content">
            
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="page active">
                <h1>ğŸ“Š ä»ªè¡¨æ¿</h1>
                
                <div class="alert alert-info">
                    <span>âš ï¸</span>
                    <span>è¯·å…ˆåœ¨ã€Œè®¾å¤‡ç®¡ç†ã€ä¸­é€‰æ‹©è®¾å¤‡ï¼Œå†è¿›è¡Œå…»å·é…ç½®ã€‚</span>
                </div>

                <h2>å½“å‰è®¾å¤‡</h2>
                <div id="current-device-display" class="status-card">
                    <div class="status-label">é€‰ä¸­è®¾å¤‡</div>
                    <div class="status-value" id="current-device-name">æœªé€‰æ‹©</div>
                </div>

                <h2>å¿«é€Ÿæ“ä½œ</h2>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="startYangHao()">â–¶ï¸ å¯åŠ¨å…»å·</button>
                    <button class="btn btn-danger" onclick="stopYangHao()">â¹ï¸ åœæ­¢å…»å·</button>
                    <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                </div>

                <h2>å…»å·çŠ¶æ€</h2>
                <div class="status-card">
                    <div class="status-label">è¿è¡ŒçŠ¶æ€</div>
                    <div class="status-value" id="running-status">âšª æœªè¿è¡Œ</div>
                </div>
                <div class="status-card">
                    <div class="status-label">å·²è®¿é—®å¸–å­</div>
                    <div class="status-value" id="visited-count">0</div>
                </div>
                <div class="status-card">
                    <div class="status-label">å‰©ä½™æ—¶é—´</div>
                    <div class="status-value" id="remain-time">0 åˆ†é’Ÿ</div>
                </div>

                <h2>è¿›åº¦</h2>
                <div class="progress">
                    <div class="progress-bar" id="progress" style="width: 0%"></div>
                </div>

                <h2>æœ€è¿‘æ“ä½œæ—¥å¿—</h2>
                <div id="log-list" style="max-height: 300px; overflow-y: auto;">
                    <div class="alert alert-info">æš‚æ— æ—¥å¿—</div>
                </div>
            </div>

            <!-- è®¾å¤‡ç®¡ç† -->
            <div id="device" class="page">
                <h1>ğŸ“± è®¾å¤‡ç®¡ç†</h1>
                
                <h2>å·²è¿æ¥è®¾å¤‡</h2>
                <button class="btn btn-primary" onclick="refreshDevices()" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
                
                <div class="device-selector" id="device-list"></div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="switchDevice()">âœ“ ç¡®è®¤é€‰æ‹©</button>
                <button class="btn btn-primary" onclick="showPage('keyword')" style="margin-left: 10px;">ä¸‹ä¸€æ­¥:  è®¾ç½®å…³é”®è¯</button>
            </div>

            <!-- å…³é”®è¯ç®¡ç† -->
            <div id="keyword" class="page">
                <h1>ğŸ” æœç´¢å…³é”®è¯ç®¡ç†</h1>
                
                <h2>å½“å‰å…³é”®è¯åˆ—è¡¨</h2>
                <div id="keyword-list"></div>

                <h2>æ·»åŠ æ–°å…³é”®è¯</h2>
                <div class="form-group">
                    <input type="text" id="new-keyword" placeholder="è¾“å…¥å…³é”®è¯ï¼Œä¾‹ï¼šç§‘æŠ€èµ„è®¯">
                    <button class="btn btn-primary" onclick="addKeyword()" style="margin-top: 10px;">â• æ·»åŠ </button>
                </div>

                <h2>æ‰¹é‡å¯¼å…¥</h2>
                <div class="form-group">
                    <textarea id="keywords-import" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼Œä¾‹ï¼š&#10;ç§‘æŠ€èµ„è®¯&#10;æ—…è¡Œæ”»ç•¥&#10;ç¾é£Ÿæ•™ç¨‹" rows="6"></textarea>
                    <button class="btn btn-primary" onclick="importKeywords()" style="margin-top: 10px;">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveKeywords()">ğŸ’¾ ä¿å­˜å…³é”®è¯</button>
            </div>

            <!-- æ ¸å¿ƒå‚æ•° -->
            <div id="param" class="page">
                <h1>âš™ï¸ æ ¸å¿ƒå‚æ•°é…ç½®</h1>

                <div class="form-group">
                    <label>å…»å·æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="duration-minutes" min="1" max="120" value="20">
                    <small style="color: #666;">èŒƒå›´ï¼š1-120åˆ†é’Ÿ</small>
                </div>

                <div class="form-group">
                    <label>è®¿é—®å¸–å­æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
                    <input type="range" id="post-visit-ratio" min="0" max="100" value="50">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="ratio-display" style="color: #667eea; font-weight: bold;">50%</span>
                        <small style="color: #666;">æœç´¢ç»“æœä¸­ä¼šè®¿é—®æ­¤æ¯”ä¾‹çš„å¸–å­</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ¯æ¬¡å…»å·æœ€å¤šç‚¹å‡»å¸–å­æ•°é‡</label>
                    <input type="number" id="max-posts" min="1" max="50" value="10">
                    <small style="color: #666;">èŒƒå›´ï¼š1-50æ¡</small>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveParams()">ğŸ’¾ ä¿å­˜å‚æ•°</button>
            </div>

            <!-- è®¿é—®æ§åˆ¶ -->
            <div id="visit" class="page">
                <h1>ğŸ‘ï¸ å¸–å­è®¿é—®æ§åˆ¶</h1>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter-image-text" checked>
                        ä»…è®¿é—®å›¾æ–‡ç±»å‹å¸–å­
                    </label>
                </div>

                <div class="form-group">
                    <label>è®¿é—®æ—¶é•¿èŒƒå›´ï¼ˆç§’ï¼‰</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="duration-min" min="5" max="60" value="25" style="flex: 1;">
                        <span>-</span>
                        <input type="number" id="duration-max" min="5" max="120" value="45" style="flex: 1;">
                    </div>
                    <small style="color: #666;">æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è®¿é—®æ—¶é•¿ï¼ˆéšæœºï¼‰</small>
                </div>

                <div class="form-group">
                    <label>å›¾ç‰‡æ»‘åŠ¨é—´éš”ï¼ˆç§’ï¼‰</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="slide-interval-min" min="1" max="10" value="3" style="flex: 1;">
                        <span>-</span>
                        <input type="number" id="slide-interval-max" min="1" max="10" value="5" style="flex: 1;">
                    </div>
                </div>

                <div class="form-group">
                    <label>æ»‘åŠ¨è·ç¦»</label>
                    <select id="slide-distance">
                        <option value="single_image">å•å¼ å›¾ç‰‡é«˜åº¦</option>
                        <option value="third_screen">å±å¹•1/3é«˜åº¦</option>
                        <option value="custom">è‡ªå®šä¹‰ï¼ˆåƒç´ ï¼‰</option>
                    </select>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveVisitControl()">ğŸ’¾ ä¿å­˜è®¿é—®æ§åˆ¶é…ç½®</button>
            </div>

            <!-- äº’åŠ¨é…ç½® -->
            <div id="interact" class="page">
                <h1>ğŸ’¬ äº’åŠ¨è¡Œä¸ºé…ç½®</h1>

                <h2>è¡Œä¸ºè§¦å‘æ¦‚ç‡</h2>

                <div class="form-group">
                    <label>ç‚¹èµæ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="like-prob" min="0" max="50" value="15">
                    <div style="display: flex; justify-content:  space-between;">
                        <span id="like-display" style="color: #667eea; font-weight:  bold;">15%</span>
                        <small style="color: #666;">é»˜è®¤15%</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ”¶è—æ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="collect-prob" min="0" max="50" value="10">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="collect-display" style="color: #667eea; font-weight:  bold;">10%</span>
                        <small style="color:  #666;">é»˜è®¤10%</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¯„è®ºæ¦‚ç‡ï¼ˆ%ï¼‰</label>
                    <input type="range" id="comment-prob" min="0" max="50" value="5">
                    <div style="display: flex; justify-content: space-between;">
                        <span id="comment-display" style="color: #667eea; font-weight: bold;">5%</span>
                        <small style="color: #666;">é»˜è®¤5%</small>
                    </div>
                </div>

                <h2>è¯„è®ºæ¨¡æ¿åº“</h2>
                <div id="comment-templates-list"></div>

                <h2>æ·»åŠ è¯„è®ºæ¨¡æ¿</h2>
                <div class="form-group">
                    <input type="text" id="new-template" placeholder="è¾“å…¥æ–°çš„è¯„è®ºæ¨¡æ¿ï¼Œä¾‹ï¼šä¸é”™çš„åˆ†äº«ï¼">
                    <button class="btn btn-primary" onclick="addCommentTemplate()" style="margin-top: 10px;">â• æ·»åŠ </button>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-success" onclick="saveInteraction()">ğŸ’¾ ä¿å­˜äº’åŠ¨é…ç½®</button>
            </div>

            <!-- å®æ—¶çŠ¶æ€ -->
            <div id="status" class="page">
                <h1>ğŸ“¡ å…»å·å®æ—¶çŠ¶æ€</h1>

                <h2>è®¾å¤‡è¿æ¥çŠ¶æ€</h2>
                <div class="status-card">
                    <div class="status-label">è¿æ¥çŠ¶æ€</div>
                    <div class="status-value" id="connection-status">ğŸ”´ ç¦»çº¿</div>
                </div>

                <h2>å…»å·è¿›åº¦</h2>
                <div class="status-card">
                    <div class="status-label">è¿è¡ŒçŠ¶æ€</div>
                    <div class="status-value" id="yangHao-running">âšª æœªè¿è¡Œ</div>
                </div>

                <div class="status-card">
                    <div class="status-label">å‰©ä½™æ—¶é—´</div>
                    <div class="status-value" id="yangHao-remain">0 åˆ†é’Ÿ</div>
                </div>

                <div class="status-card">
                    <div class="status-label">å·²è®¿é—®å¸–å­</div>
                    <div class="status-value" id="yangHao-visited">0</div>
                </div>

                <h2>å…»å·è¿›åº¦æ¡</h2>
                <div class="progress">
                    <div class="progress-bar" id="yangHao-progress" style="width: 0%"></div>
                </div>

                <h2>å½“å‰æ“ä½œ</h2>
                <div class="status-card">
                    <div class="status-label">æœç´¢å…³é”®è¯</div>
                    <div class="status-value" id="current-keyword">-</div>
                </div>

                <h2>æ“ä½œ</h2>
                <button class="btn btn-primary" onclick="autoRefreshStatus()" style="margin-bottom: 15px;">ğŸ”„ è‡ªåŠ¨åˆ·æ–°çŠ¶æ€ï¼ˆæ¯3ç§’ï¼‰</button>
                <button class="btn btn-warning" onclick="stopAutoRefresh()">â¸ï¸ åœæ­¢è‡ªåŠ¨åˆ·æ–°</button>

                <h2>å®æ—¶æ—¥å¿—</h2>
                <div id="status-log" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                    <div style="color: #666;">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentDevice = null;
        let autoRefreshInterval = null;
        let operationLog = [];

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(pageName) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­é¡µé¢
            document.getElementById(pageName).classList.add('active');
            
            // æ›´æ–°å¯¼èˆªæ æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // è¿›å…¥é¡µé¢æ—¶åˆ·æ–°æ•°æ®
            if (pageName === 'device') {
                refreshDevices();
            } else if (pageName === 'keyword') {
                loadKeywords();
            } else if (pageName === 'param') {
                loadParams();
            } else if (pageName === 'visit') {
                loadVisitControl();
            } else if (pageName === 'interact') {
                loadInteraction();
            } else if (pageName === 'status') {
                loadStatus();
            } else if (pageName === 'dashboard') {
                refreshStatus();
            }
        }

        // ==================== æ—¥å¿—ç®¡ç† ====================
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            operationLog.unshift(`[${timestamp}] ${message}`);
            if (operationLog.length > 50) operationLog.pop();
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            let logHtml = '';
            operationLog.forEach(log => {
                logHtml += `<div>${log}</div>`;
            });
            const logElement = document.getElementById('log-list');
            if (logElement) {
                logElement.innerHTML = logHtml || '<div class="alert alert-info">æš‚æ— æ—¥å¿—</div>';
            }
        }

        // ==================== è®¾å¤‡ç®¡ç† ====================
        function refreshDevices() {
            fetch('/api/devices')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        renderDeviceList(data.data);
                        addLog('å·²åˆ·æ–°è®¾å¤‡åˆ—è¡¨');
                    } else {
                        alert('é”™è¯¯:  ' + data.error);
                    }
                })
                .catch(err => {
                    alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:  ' + err.message);
                    addLog('âŒ è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
                });
        }

        function renderDeviceList(devices) {
            const listHtml = devices.map(device => `
                <div class="device-option">
                    <input type="radio" name="device" id="dev-${device.id}" value="${device.id}" ${currentDevice === device.id ? 'checked' : ''}>
                    <label for="dev-${device.id}">
                        <strong>${device.name}</strong><br>
                        <small style="opacity: 0.7;">${device.status}</small>
                    </label>
                </div>
            `).join('');
            document.getElementById('device-list').innerHTML = listHtml;
        }

        function switchDevice() {
            const selected = document.querySelector('input[name="device"]: checked');
            if (!selected) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¾å¤‡');
                return;
            }

            const deviceId = selected.value;
            fetch('/api/device/switch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: deviceId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    currentDevice = deviceId;
                    document.getElementById('current-device-name').textContent = selected.labels[0]. textContent. split('\n')[0];
                    alert(data.message);
                    addLog(`âœ“ å·²åˆ‡æ¢åˆ°è®¾å¤‡:  ${deviceId}`);
                } else {
                    alert('é”™è¯¯: ' + data.error);
                    addLog(`âŒ è®¾å¤‡åˆ‡æ¢å¤±è´¥: ${data.error}`);
                }
            })
            .catch(err => {
                alert('åˆ‡æ¢è®¾å¤‡å¤±è´¥: ' + err.message);
                addLog('âŒ åˆ‡æ¢è®¾å¤‡å¼‚å¸¸');
            });
        }

        // ==================== å…³é”®è¯ç®¡ç† ====================
        function loadKeywords() {
            if (! currentDevice) {
                alert('è¯·å…ˆåœ¨è®¾å¤‡ç®¡ç†é¡µé¢é€‰æ‹©è®¾å¤‡');
                return;
            }

            fetch(`/api/config/keywords/${currentDevice}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        renderKeywordList(data.data);
                    }
                })
                .catch(err => console.error(err));
        }

        function renderKeywordList(keywords) {
            const listHtml = keywords.map((kw, idx) => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-text">${kw}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteKeyword(${idx})">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('keyword-list').innerHTML = listHtml || '<p style="color: #666;">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å…³é”®è¯</p>';
        }

        function addKeyword() {
            const input = document.getElementById('new-keyword');
            const keyword = input. value.trim();
            
            if (!keyword) {
                alert('è¯·è¾“å…¥å…³é”®è¯');
                return;
            }
            
            if (! currentDevice) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }

            // è·å–å½“å‰å…³é”®è¯åˆ—è¡¨
            fetch(`/api/config/${currentDevice}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const keywords = data.data.keywords || [];
                        if (keywords.includes(keyword)) {
                            alert('è¯¥å…³é”®è¯å·²å­˜åœ¨');
                            return;
                        }
                        keywords.push(keyword);
                        
                        // ä¿å­˜
                        data.data.keywords = keywords;
                        fetch(`/api/config/${currentDevice}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data.data)
                        })
                        .then(r => r.json())
                        .then(res => {
                            if (res.success) {
                                input.value = '';
                                loadKeywords();
                                addLog(`âœ“ å·²æ·»åŠ å…³é”®è¯: ${keyword}`);
                            }
                        });
                    }
                })
                .catch(err => console.error(err));
        }

        function deleteKeyword(idx) {
            if (! currentDevice) return;
            
            fetch(`/api/config/${currentDevice}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const keywords = data.data.keywords || [];
                        const deleted = keywords.splice(idx, 1)[0];
                        
                        data.data.keywords = keywords;
                        fetch(`/api/config/${currentDevice}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data.data)
                        })
                        .then(r => r.json())
                        .then(res => {
                            if (res.success) {
                                loadKeywords();
                                addLog(`âœ“ å·²åˆ é™¤å…³é”®è¯: ${deleted}`);
                            }
                        });
                    }
                });
        }

        function importKeywords() {
            const text = document.getElementById('keywords-import').value;
            const keywords = text.split('\n').map(k => k.trim()).filter(k => k);
            
            if (keywords.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå…³é”®è¯');
                return;
            }

            if (!currentDevice) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }

            fetch(`/api/config/${currentDevice}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const currentKeywords = data.data.keywords || [];
                        const newKeywords = keywords.filter(k => !currentKeywords.includes(k));
                        
                        if (newKeywords.length === 0) {
                            alert('æ‰€æœ‰å…³é”®è¯éƒ½å·²å­˜åœ¨');
                            return;
                        }
                        
                        currentKeywords.push(...newKeywords);
                        data.data.keywords = currentKeywords;
                        
                        fetch(`/api/config/${currentDevice}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data.data)
                        })
                        .then(r => r.json())
                        .then(res => {
                            if (res.success) {
                                document.getElementById('keywords-import').value = '';
                                loadKeywords();
                                addLog(`âœ“ å·²å¯¼å…¥ ${newKeywords.length} ä¸ªæ–°å…³é”®è¯`);
                            }
                        });
                    }
                })
                .catch(err => console.error(err));
        }